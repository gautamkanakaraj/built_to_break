===========================================
WALLET ENGINE: SYSTEM DOCUMENTATION
===========================================

1. SYSTEM ARCHITECTURE FLOW
-------------------------------------------
The Wallet Engine is a monolithic REST API service designed for financial operations.

[ Client / Test Script ]
        | (HTTP/JSON)
        v
[ FastAPI Application (Sync) ]
        |
   +----+----+
   |         |
   v         v
[ Router ] [ CRUD Layer ]
   |         |
   |         v
   |    [ SQLAlchemy ORM ]
   |         | (Sync Driver)
   +----+----+
        |
        v
[ PostgreSQL Database ]

FLOW:
1. Request: Client sends HTTP POST/GET.
2. Routing: FastAPI routes to `app/api/`.
3. Validation: Pydantic schemas validate input types (but NOT business logic state or idempotency).
4. Logic: `app/crud/` executes business logic.
5. Persistence: logic interacts with `SessionLocal` to query/update DB.
6. Commit: Changes are committed (Autocommit=False, explicit commit used).

2. DATABASE DIAGRAM (Schema)
-------------------------------------------

  +----------------+       +------------------+
  |     USERS      |       |     WALLETS      |
  +----------------+       +------------------+
  | id (PK)        | <---- | id (PK)          |
  | username       | 1   1 | user_id (FK)     |
  | email          |       | balance (Float)  |
  +----------------+       | status (Enum)    |
                           +------------------+
                                    ^ 1
                                    |
                                    | N
                           +------------------+
                           |   TRANSACTIONS   |
                           +------------------+
                           | id (PK)          |
                           | from_wallet_id   | >---(FK)--+
                           | to_wallet_id     | >---(FK)--+
                           | amount (Float)   |
                           | timestamp        |
                           +------------------+

- Relationships:
  - User has ONE Wallet (1:1).
  - Wallet has MANY Transactions (as sender or receiver).

3. CURRENT CAPABILITIES (What Works)
-------------------------------------------
- **User Management**: Create user, Read users.
- **Wallet Management**: Create wallet, Deposit funds (positive/negative), Check balance.
- **Transfers**: 
  - `POST /transfer/`: Move money between wallets.
  - Checks for sufficient funds and wallet status.
  - Updates balances and creates transaction record.

4. RELIABILITY ANALYSIS (Supported vs Failed)
-------------------------------------------

[ SUPPORTED CONCEPTS ]
- **Persistence**: Data survives restarts (PostgreSQL).
- **Basic ACID (Single-Step)**: Database ensures basic row-level integrity for single updates.
- **Input Validation**: Pydantic ensures data types are correct (e.g., amount is a number).

[ FAILED / VULNERABLE CONCEPTS ]
The system is currently VULNERABLE to several financial reliability issues, as verified by automated tests.

1. **ISOLATION (Read Skew / Repeatable Reads)**
   - STATUS: FAILED
   - Proof: `isolation_test.py`
   - Description: A user reading Account A then Account B while a transfer is happening in the background will see an inconsistent total (money appears/disappears momentarily).
   - Cause: Default Isolation Level (Read Committed) used without specific Snapshot isolation or locking.

2. **ATOMICITY (Distributed / Multi-step)**
   - STATUS: FAILED
   - Proof: `test_atomicity.py`
   - Description: Chaining multiple API calls (e.g., Withdraw A -> Deposit B) allows partial commits. If the second call fails, money is permanently destroyed from A without reaching B.
   - Cause: No API-level support for Two-Phase Commit (2PC) or Sagas.

3. **IDEMPOTENCY (Replay Protection)**
   - STATUS: FAILED
   - Proof: `test_idempotency.py`
   - Description: Sending the exact same Transfer request 5 times results in 5 separate transfers.
   - Cause: No `idempotency_key` header or unique constraint on transaction payloads.

4. **CONCURRENCY CONTROL (Double Spend)**
   - STATUS: VULNERABLE (By Design)
   - Description: The code explicitly avoids `SELECT ... FOR UPDATE`, allowing Race Conditions where two concurrent threads can spend the same balance.

===========================================
GENERATED BY: Antigravity Agent
DATE: 2026-01-08
===========================================
